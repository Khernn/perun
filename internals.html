
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Perun Internals &#8212; Perun 0.14.1 documentation</title>
    <link rel="stylesheet" href="_static/perun.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.14.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Changelog" href="changelog.html" />
    <link rel="prev" title="Customize Logs and Statuses" href="logs.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="perun-internals">
<span id="internals-overview"></span><h1>Perun Internals<a class="headerlink" href="#perun-internals" title="Permalink to this headline">¶</a></h1>
<p>Conceptually one Perun instances serves as a wrapper around the existing version control system
(e.g. some repository). Perun takes specializes on storing the performance profiles and manages the
link between minor versions and their corresponding profiles. Currently as a target vcs we support
only <code class="docutils literal"><span class="pre">git</span></code>, with a custom lightweigth vcs being in development (called <code class="docutils literal"><span class="pre">tagit</span></code>). The
architecture of Perun contains an interface that can be used to register support for new version
control system as described in <a class="reference internal" href="#internals-vcs-custom"><span class="std std-ref">Creating Support for Custom VCS</span></a>. Internal structure of one instance of
Perun is inspired by git: performance profiles are similarly stored as objects compressed by zlib
method and identified by hashes. <a class="reference internal" href="#internals-store"><span class="std std-ref">Perun Storage</span></a> describes the internal model of Perun more
briefly.</p>
<a class="reference internal image-reference" href="_images/perun-vs-vcs.svg"><div align="center" class="align-center"><img alt="_images/perun-vs-vcs.svg" src="_images/perun-vs-vcs.svg" width="100%" /></div>
</a>
<p>The diagram above highlights the responsibilities and storage of individual systems. Version
control systems manage the functionality of the project—its versions and precise code
changes—but lack proper support for managing performance. On the other hand, performance
versioning systems manages the performance of project—its individual performance profiles, data
visualizations of various statistics—but lack the precise functionality changes. This means that
vcs stores the actual code chungs and version references and pvs stores the actual profiling data.</p>
<a class="reference internal image-reference" href="_images/perun-flow.svg"><div align="center" class="align-center"><img alt="_images/perun-flow.svg" src="_images/perun-flow.svg" width="100%" /></div>
</a>
<p>This diagram shows one of the proper usages of Perun’s tool suite. Each developer keeps his own
instance of both versioning and performance systems. In this mode one can share both the code
changes and performance measurement through the wider range of developers.</p>
<div class="section" id="version-control-systems">
<span id="internals-vcs"></span><h2>Version Control Systems<a class="headerlink" href="#version-control-systems" title="Permalink to this headline">¶</a></h2>
<p>Version Control System manages the history of functionality of one project, i.e. stores the changes
between different versions (or snapshots) of project. Each code change usually requires
corresponding the performance profiles in order to detect potential performance degradation early
in the development. The following subsection <a class="reference internal" href="#internals-vcs-api"><span class="std std-ref">Version Control System API</span></a> describes the layer which
serves as an interface in Perun which supplies the necessary information between the version
control and performance versioning systems.</p>
<div class="section" id="module-perun.vcs">
<span id="version-control-system-api"></span><span id="internals-vcs-api"></span><h3>Version Control System API<a class="headerlink" href="#module-perun.vcs" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="perun.vcs.init">
<code class="descclassname">perun.vcs.</code><code class="descname">init</code><span class="sig-paren">(</span><em>vcs_type</em>, <em>vcs_path</em>, <em>vcs_init_params</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/perun/vcs.html#init"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#perun.vcs.init" title="Permalink to this definition">¶</a></dt>
<dd><p>Calls the implementation of initialization of wrapped underlying version
control system.</p>
<p>The initialization should take care of both reinitialization of existing
version control system instances and newly created instances. Init is
called during the <code class="docutils literal"><span class="pre">perun</span> <span class="pre">init</span></code> command from command line interface.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>vcs_type</strong> (<em>str</em>) – type of the underlying wrapped version control system</li>
<li><strong>vcs_path</strong> (<em>str</em>) – destination path of the initialized wrapped vcs</li>
<li><strong>vcs_init_params</strong> (<em>dict</em>) – dictionary of keyword arguments passed to
initialization method of the underlying vcs module</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">true if the underlying vcs was successfully initialized</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="perun.vcs.walk_minor_versions">
<code class="descclassname">perun.vcs.</code><code class="descname">walk_minor_versions</code><span class="sig-paren">(</span><em>vcs_type</em>, <em>vcs_path</em>, <em>head_minor_version</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/perun/vcs.html#walk_minor_versions"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#perun.vcs.walk_minor_versions" title="Permalink to this definition">¶</a></dt>
<dd><p>Generator of minor versions for the given major version, which yields
the <code class="docutils literal"><span class="pre">MinorVersion</span></code> named tuples containing the following information:
<code class="docutils literal"><span class="pre">date</span></code>, <code class="docutils literal"><span class="pre">author</span></code>, <code class="docutils literal"><span class="pre">email</span></code>, <code class="docutils literal"><span class="pre">checksum</span></code> (i.e. the hash representation
of the minor version), <code class="docutils literal"><span class="pre">commit_description</span></code> and <code class="docutils literal"><span class="pre">commit_parents</span></code> (i.e.
other minor versions).</p>
<p>Minor versions are walked through this function during the <code class="docutils literal"><span class="pre">perun</span> <span class="pre">log</span></code>
command.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>vcs_type</strong> (<em>str</em>) – type of the underlying wrapped version control system</li>
<li><strong>vcs_path</strong> (<em>str</em>) – source path of the wrapped vcs</li>
<li><strong>head_minor_version</strong> (<em>str</em>) – the root minor versions which is the root
of the walk.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">iterable stream of minor version representation</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="perun.vcs.walk_major_versions">
<code class="descclassname">perun.vcs.</code><code class="descname">walk_major_versions</code><span class="sig-paren">(</span><em>vcs_type</em>, <em>vcs_path</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/perun/vcs.html#walk_major_versions"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#perun.vcs.walk_major_versions" title="Permalink to this definition">¶</a></dt>
<dd><p>Generator of major versions for the current wrapped repository.</p>
<p>This function is currently unused, but will be needed in the future.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>vcs_type</strong> (<em>str</em>) – type of the underlying wrapped version control system</li>
<li><strong>vcs_path</strong> (<em>str</em>) – source path of the wrapped vcs</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">iterable stream of major version representation</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="perun.vcs.get_minor_head">
<code class="descclassname">perun.vcs.</code><code class="descname">get_minor_head</code><span class="sig-paren">(</span><em>vcs_type</em>, <em>vcs_path</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/perun/vcs.html#get_minor_head"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#perun.vcs.get_minor_head" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the string representation of head of current major version, i.e.
for git this returns the massaged HEAD reference.</p>
<p>This function is called mainly during the outputs of <code class="docutils literal"><span class="pre">perun</span> <span class="pre">log</span></code> and
<code class="docutils literal"><span class="pre">perun</span> <span class="pre">status</span></code> but also during the automatic generation of profiles
(either by <code class="docutils literal"><span class="pre">perun</span> <span class="pre">run</span></code> or <code class="docutils literal"><span class="pre">perun</span> <span class="pre">collect</span></code>), where the retrieved
identification is used as <a class="reference internal" href="profile.html#perfreg-origin"><code class="xref std std-preg docutils literal"><span class="pre">origin</span></code></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>vcs_type</strong> (<em>str</em>) – type of the underlying wrapped version control system</li>
<li><strong>vcs_path</strong> (<em>str</em>) – source path of the wrapped vcs</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">unique string representation of current head (usually in SHA)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Raises:</th><td class="field-body"><p class="first last"><strong>ValueError</strong> – if the head cannot be retrieved from the current
context</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="perun.vcs.get_head_major_version">
<code class="descclassname">perun.vcs.</code><code class="descname">get_head_major_version</code><span class="sig-paren">(</span><em>vcs_type</em>, <em>vcs_path</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/perun/vcs.html#get_head_major_version"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#perun.vcs.get_head_major_version" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the string representation of current major version of the
wrapped repository.</p>
<p>Major version is displayed during the <code class="docutils literal"><span class="pre">perun</span> <span class="pre">status</span></code> output, which shows
the current working major version of the project.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>vcs_type</strong> (<em>str</em>) – type of the underlying wrapped version control system</li>
<li><strong>vcs_path</strong> (<em>str</em>) – source path of the wrapped vcs</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">string representation of the major version</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="perun.vcs.get_minor_version_info">
<code class="descclassname">perun.vcs.</code><code class="descname">get_minor_version_info</code><span class="sig-paren">(</span><em>vcs_type</em>, <em>vcs_path</em>, <em>minor_version</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/perun/vcs.html#get_minor_version_info"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#perun.vcs.get_minor_version_info" title="Permalink to this definition">¶</a></dt>
<dd><p>Yields the specification of concrete minor version in form of
the <code class="docutils literal"><span class="pre">MinorVersion</span></code> named tuples containing the following information:
<code class="docutils literal"><span class="pre">date</span></code>, <code class="docutils literal"><span class="pre">author</span></code>, <code class="docutils literal"><span class="pre">email</span></code>, <code class="docutils literal"><span class="pre">checksum</span></code> (i.e. the hash representation
of the minor version), <code class="docutils literal"><span class="pre">commit_description</span></code> and <code class="docutils literal"><span class="pre">commit_parents</span></code> (i.e.
other minor versions).</p>
<p>This function is a non-generator alternative of
<a class="reference internal" href="#perun.vcs.walk_minor_versions" title="perun.vcs.walk_minor_versions"><code class="xref py py-func docutils literal"><span class="pre">perun.vcs.walk_minor_versions()</span></code></a> and is used during the <code class="docutils literal"><span class="pre">perun</span>
<span class="pre">status</span></code> output to display the specifics of minor version.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>vcs_type</strong> (<em>str</em>) – type of the underlying wrapped version control system</li>
<li><strong>vcs_path</strong> (<em>str</em>) – source path of the wrapped vcs</li>
<li><strong>minor_version</strong> (<em>str</em>) – the specification of minor version (in form of
sha e.g.) for which we are retrieving the details</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">minor version named tuple</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="perun.vcs.check_minor_version_validity">
<code class="descclassname">perun.vcs.</code><code class="descname">check_minor_version_validity</code><span class="sig-paren">(</span><em>vcs_type</em>, <em>vcs_path</em>, <em>minor_version</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/perun/vcs.html#check_minor_version_validity"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#perun.vcs.check_minor_version_validity" title="Permalink to this definition">¶</a></dt>
<dd><p>Checks whether the given minor version specification corresponds to the
wrapped version control system, and is not in wrong format.</p>
<p>Minor version validity is mostly checked during the lookup of the minor
versions from the command line interface.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>vcs_type</strong> (<em>str</em>) – type of the underlying wrapped version control system</li>
<li><strong>vcs_path</strong> (<em>str</em>) – source path of the wrapped vcs</li>
<li><strong>minor_version</strong> (<em>str</em>) – the specification of minor version (in form of
sha e.g.) for which we are checking the validity</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Raises:</th><td class="field-body"><p class="first last"><strong>VersionControlSystemException</strong> – when the given minor version is
invalid in the context of the wrapped version control system.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="perun.vcs.massage_parameter">
<code class="descclassname">perun.vcs.</code><code class="descname">massage_parameter</code><span class="sig-paren">(</span><em>vcs_type</em>, <em>vcs_path</em>, <em>parameter</em>, <em>parameter_type=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/perun/vcs.html#massage_parameter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#perun.vcs.massage_parameter" title="Permalink to this definition">¶</a></dt>
<dd><p>Conversion function for massaging (or unifying different representations
of objects) the parameters for version control systems.</p>
<p>Massaging is mainly executed during from the command line interface, when
one can e.g. use the references (like <code class="docutils literal"><span class="pre">HEAD</span></code>) to specify concrete minor
versions. Massing then unifies e.g. the references or proper hash
representations, to just one representation for internal processing.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>vcs_type</strong> (<em>str</em>) – type of the underlying wrapped version control system</li>
<li><strong>vcs_path</strong> (<em>str</em>) – source path of the wrapped vcs</li>
<li><strong>parameter</strong> (<em>str</em>) – vcs parameter (e.g. revision, minor or major version)
which will be massaged, i.e. transformed to unified representation</li>
<li><strong>parameter_type</strong> (<em>str</em>) – more detailed type of the parameter</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">string representation of parameter</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="perun.vcs.is_dirty">
<code class="descclassname">perun.vcs.</code><code class="descname">is_dirty</code><span class="sig-paren">(</span><em>vcs_type</em>, <em>vcs_path</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/perun/vcs.html#is_dirty"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#perun.vcs.is_dirty" title="Permalink to this definition">¶</a></dt>
<dd><p>Tests whether the wrapped repository is dirty.</p>
<p>By dirty repository we mean a repository that has either a submitted changes to its index (i.e.
we are in the middle of commit) or any unsubmitted changes to tracked files in the current
working directory.</p>
<p>Note that this is crucial for performance testing, as any uncommited changes may skew
the profiled data and hence the resulting profiles would not correctly represent the performance
of minor versions.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>vcs_type</strong> (<em>str</em>) – type of the underlying wrapped version control system</li>
<li><strong>vcs_path</strong> (<em>str</em>) – source path of the wrapped vcs</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">whether the given repository is dirty or not</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="perun.vcs.save_state">
<code class="descclassname">perun.vcs.</code><code class="descname">save_state</code><span class="sig-paren">(</span><em>vcs_type</em>, <em>vcs_path</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/perun/vcs.html#save_state"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#perun.vcs.save_state" title="Permalink to this definition">¶</a></dt>
<dd><p>Saves the state of the repository in case it is dirty.</p>
<p>When saving the state of the repository one should store all of the uncommited changes to
the working directory and index. Any issues while this process happens should be handled by
user itself, hence no workarounds and mending should take place in this function.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>vcs_type</strong> (<em>str</em>) – type of the underlying wrapped version control system</li>
<li><strong>vcs_path</strong> (<em>str</em>) – source path of the wrapped vcs</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last"></p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="perun.vcs.restore_state">
<code class="descclassname">perun.vcs.</code><code class="descname">restore_state</code><span class="sig-paren">(</span><em>vcs_type</em>, <em>vcs_path</em>, <em>saved</em>, <em>state</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/perun/vcs.html#restore_state"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#perun.vcs.restore_state" title="Permalink to this definition">¶</a></dt>
<dd><p>Restores the previous state of the the repository</p>
<p>When restoring the state of the repository one should pop the stored changes from the stash
and reapply them on the current directory. This make sure, that after the performance testing,
the project is in the previous state and developer can continue with his work.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>vcs_type</strong> (<em>str</em>) – type of the underlying wrapped version control system</li>
<li><strong>vcs_path</strong> (<em>str</em>) – source path of the wrapped vcs</li>
<li><strong>saved</strong> (<em>bool</em>) – whether the stashed was something</li>
<li><strong>state</strong> (<em>str</em>) – the previous state of the repository</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="perun.vcs.checkout">
<code class="descclassname">perun.vcs.</code><code class="descname">checkout</code><span class="sig-paren">(</span><em>vcs_type</em>, <em>vcs_path</em>, <em>minor_version</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/perun/vcs.html#checkout"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#perun.vcs.checkout" title="Permalink to this definition">¶</a></dt>
<dd><p>Checks out the new working directory corresponding to the given minor version.</p>
<p>According to the supplied minor version, this command should remake the working directory
so it corresponds to the state defined by the minor version.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>vcs_type</strong> (<em>str</em>) – type of the underlying wrapped version control system</li>
<li><strong>vcs_path</strong> (<em>str</em>) – source path of the wrapped vcs</li>
<li><strong>minor_version</strong> (<em>str</em>) – minor version that will be checked out</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="creating-support-for-custom-vcs">
<span id="internals-vcs-custom"></span><h3>Creating Support for Custom VCS<a class="headerlink" href="#creating-support-for-custom-vcs" title="Permalink to this headline">¶</a></h3>
<p>You can register support for your own version control system as follows:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Create a new module in <code class="docutils literal"><span class="pre">perun/vcs</span></code> directory implementing functions from
<a class="reference internal" href="#internals-vcs-api"><span class="std std-ref">Version Control System API</span></a>.</li>
<li>Finally register your newly created vcs wrapper in <code class="xref py py-func docutils literal"><span class="pre">get_supported_module_names()</span></code>
located in <code class="docutils literal"><span class="pre">perun.utils.__init__.py</span></code>:</li>
</ol>
<div class="highlight-udiff"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gd">--- /mnt/f/phdwork/perun/gh-pages/docs/_static/templates/supported_module_names.py</span>
<span class="gi">+++ /mnt/f/phdwork/perun/gh-pages/docs/_static/templates/supported_module_names_collectors.py</span>
<span class="gu">@@ -6,7 +6,7 @@</span>
         ))
     return {
         &#39;vcs&#39;: [&#39;git&#39;],
<span class="gd">-        &#39;collect&#39;: [&#39;complexity&#39;, &#39;memory&#39;, &#39;time&#39;],</span>
<span class="gi">+        &#39;collect&#39;: [&#39;complexity&#39;, &#39;memory&#39;, &#39;time&#39;, &#39;mycollector&#39;],</span>
         &#39;postprocess&#39;: [&#39;filter&#39;, &#39;normalizer&#39;, &#39;regression_analysis&#39;],
         &#39;view&#39;: [&#39;alloclist&#39;, &#39;bars&#39;, &#39;flamegraph&#39;, &#39;flow&#39;, &#39;heapmap&#39;, &#39;raw&#39;, &#39;scatter&#39;]
     }[package]
</pre></div>
</td></tr></table></div>
<ol class="arabic" start="3">
<li><p class="first">Optionally implement batch of automatic test cases using (preferably based on <a class="reference external" href="https://docs.pytest.org/en/latest/">pytest</a>) in
<code class="docutils literal"><span class="pre">tests</span></code> directory. Verify that registering did not break anything in the Perun, your
wrapper is correct and optionally reinstall Perun:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">test</span>
<span class="n">make</span> <span class="n">install</span>
</pre></div>
</div>
</li>
<li><p class="first">If you think your wrapper could help others, please, consider making <a class="reference external" href="https://github.com/tfiedor/perun/pull/new/develop">Pull Request</a>.</p>
</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="perun-storage">
<span id="internals-store"></span><h2>Perun Storage<a class="headerlink" href="#perun-storage" title="Permalink to this headline">¶</a></h2>
<p>The current internal representation of Perun storage is based on git internals and is meant for
easy distribution, flexibility and easier managing. The possible extension of Perun to different
versions of storages is currently under consideration. Internal objects and files for one local
instance of Perun are stored in the filesystem in the <code class="docutils literal"><span class="pre">.perun</span></code> directory consisting of the
following infrastructure:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">perun</span><span class="o">/</span>
    <span class="o">|--</span> <span class="o">/</span><span class="n">jobs</span>
    <span class="o">|--</span> <span class="o">/</span><span class="n">objects</span>
    <span class="o">|--</span> <span class="n">local</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">.perun/jobs</span></code>:</dt>
<dd><p class="first">Contains pending jobs, i.e. those that were generated by collectors, postprocessed by some
postprocessors, or automatically generated by <code class="docutils literal"><span class="pre">perun</span> <span class="pre">run</span></code> commands, but are not yet assigned
to concrete minor versions. These profiles contains the tag <a class="reference internal" href="profile.html#perfreg-origin"><code class="xref std std-preg docutils literal"><span class="pre">origin</span></code></a> that maps the
profile to concrete minor version, i.e. the parent of the profile. This key serves as a
prevention of assigning profiles to incorrect minor versions.</p>
<div class="last highlight-bash"><div class="highlight"><pre><span></span>.perun/jobs
    <span class="p">|</span>-- /baseline.perf
    <span class="p">|</span>-- /sll-comparison.perf
    <span class="p">|</span>-- /skip-lists-medium-height.perf
    <span class="p">|</span>-- /skip-lists-unlimited-height.perf
</pre></div>
</div>
</dd>
<dt><code class="docutils literal"><span class="pre">.perun/objects</span></code>:</dt>
<dd><p class="first">Corresponds to main storage of Perun and contains object primitives. Every object of Perun is
represented by unique identifier (mostly by sha representation) and corresponds either to an
object blob (containing compressed profile) or to an index of a corresponding minor version,
which lists assigned profiles for the given minor version.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>.perun/objects
    <span class="p">|</span>-- /07
        <span class="p">|</span>-- f2b4bfa06f6b1be5713f2bbae7740838456758
        <span class="p">|</span>-- 99dc4c5891947bdf7e26341231ca533432a1f1
    <span class="p">|</span>-- /3d
        <span class="p">|</span>-- 3859b46db4eea5866a0b2b28997fac25a95430
    <span class="p">|</span>-- /ff
        <span class="p">|</span>-- d35c8962d8d2019d7762a7bc6980c1d0f2fcd7
        <span class="p">|</span>-- d88aabca6e5427c78ea647e955ffa00d1cd615
</pre></div>
</div>
<p class="last">Each object from <code class="docutils literal"><span class="pre">.perun/objects</span></code> is represented by hash value, where the first two characters
are used to specify directory and the rest of the hash value a file name, where the index or
compressed file is stored.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">local.yml</span></code>:</dt>
<dd>Contains local configuration, e.g. the specification of wrapped repository, job matrixes or
formatting strings corresponding to concrete VCS. See <a class="reference internal" href="config.html"><span class="doc">Perun Configuration files</span></a> for more information about
configuration of Perun.</dd>
</dl>
<div class="section" id="perun-index-specification">
<h3>Perun Index Specification<a class="headerlink" href="#perun-index-specification" title="Permalink to this headline">¶</a></h3>
<p>Each minor version of vcs, which has any profile assigned, has corresponding index file in the
<code class="docutils literal"><span class="pre">.perun/object</span></code> according to its identification. The index file itself is stored in binary format
with the following specification.</p>
<a class="reference internal image-reference" href="_images/perun-index-spec.svg"><div align="center" class="align-center"><img alt="_images/perun-index-spec.svg" src="_images/perun-index-spec.svg" width="100%" /></div>
</a>
<dl class="docutils">
<dt><cite>Index signature</cite> [4B]:</dt>
<dd>Signature are the first bytes of the index containing ascii string <cite>pidx</cite>, which serves as an
quick identification of minor version index.</dd>
<dt><cite>Index version</cite> [4B]:</dt>
<dd>Specification of version of conding of the index. Versioning is introduced for potential future
backward compatibility with possible different specifications of index.</dd>
<dt><cite>Number of Entries</cite> [4B]:</dt>
<dd>Integer count of the number of entries found in the index. Each entry of the index is of
variable length and lists the profiles with mapping to their corresponding objects.</dd>
<dt><cite>Entries</cite> [<cite>variable length</cite>]:</dt>
<dd><p class="first">One entry of the index corresponds to one assigned profile. Each entry is of variable lenght
and contains the identification of the original profile file, together with timestamp of
creation and the identification of the compressed object, that contains the actual profiling
data. Each entry can be broken into following parts:</p>
<ul class="last simple">
<li><cite>Creation time</cite> [4B]: creation time of the profile represented as 4B timestamp.</li>
<li><cite>Profile ID</cite> [20B]: unique identification of the profile, i.e. specification of the concrete
compressed object located in the <code class="docutils literal"><span class="pre">.perun/objects</span></code>. Profile ID is always in form of SHA-1
hash, which is obtained from the contents.</li>
<li><cite>Origin Path</cite> [<cite>variable length</cite>: Original path to the profile represented as ascii string of
variable length terminated by null byte.</li>
</ul>
</dd>
<dt><cite>Checksum</cite> [20B]:</dt>
<dd>Checksum of the whole index, which serves for error detection.</dd>
</dl>
</div>
<div class="section" id="perun-object-specification">
<h3>Perun Object Specification<a class="headerlink" href="#perun-object-specification" title="Permalink to this headline">¶</a></h3>
<p>Each non-index object consist of short header ended with zero byte, consisting of header signature
string, type of the profile and lenght of the content, and raw content of the performance profile
w.r.t. <a class="reference internal" href="profile.html#profile-spec"><span class="std std-ref">Specification of Profile Format</span></a>. First we compute the checksum for these data, which serves as an
identification in the minor version indexes and in <code class="docutils literal"><span class="pre">.perun/objects</span></code> directory. Finally, the
object is compressed using zlib method and stored in the <code class="docutils literal"><span class="pre">.perun/objects</span></code> compressed.</p>
<a class="reference internal image-reference" href="_images/perun-object-spec.svg"><div align="center" class="align-center"><img alt="_images/perun-object-spec.svg" src="_images/perun-object-spec.svg" width="100%" /></div>
</a>
<dl class="docutils">
<dt><cite>Signature</cite> [7B]:</dt>
<dd>Signature is a 7B prefix containing ascii string “profile”. Serves for quick identification of
profile.</dd>
<dt><cite>Type</cite> [<cite>variable length</cite>]:</dt>
<dd>Ascii specification of the profile type. This serves for quick and easy parsing of profiles.</dd>
<dt><cite>Content Lenght</cite> [4B]:</dt>
<dd>Integer count of the non-header data followed after the zero byte in bytes.</dd>
<dt><cite>Content</cite> [<cite>variable length</cite>]:</dt>
<dd>Contents of the performance profile w.r.t. <a class="reference internal" href="profile.html#profile-spec"><span class="std std-ref">Specification of Profile Format</span></a>.</dd>
</dl>
</div>
<div class="section" id="the-lifetime-of-profile-internals">
<h3>The Lifetime of profile: Internals<a class="headerlink" href="#the-lifetime-of-profile-internals" title="Permalink to this headline">¶</a></h3>
<p>The following subsections describes in more detail the basics of profile manipulations, namely
registering, removing and lookuping up profiles.</p>
<div class="section" id="registering-new-profile">
<h4>Registering new profile<a class="headerlink" href="#registering-new-profile" title="Permalink to this headline">¶</a></h4>
<p>Given a profile, w.r.t. <a class="reference internal" href="profile.html#profile-spec"><span class="std std-ref">Specification of Profile Format</span></a>, called <code class="docutils literal"><span class="pre">sll-vs-skiplist.perf</span></code>, registering this
profile in <code class="docutils literal"><span class="pre">HEAD</span></code> minor version index, the following steps are executed:</p>
<blockquote>
<div><ol class="arabic simple">
<li><code class="docutils literal"><span class="pre">sll-vs-skiplist.perf</span></code> is loaded and parsed into <a class="reference external" href="https://www.json.org/">JSON</a>. Profile is verified whether it is
in format specified by <a class="reference internal" href="profile.html#profile-spec"><span class="std std-ref">Specification of Profile Format</span></a>.</li>
<li><a class="reference internal" href="profile.html#perfreg-origin"><code class="xref std std-preg docutils literal"><span class="pre">origin</span></code></a> key is compared with the massaged <code class="docutils literal"><span class="pre">HEAD</span></code> minor version. In case it
differes, an error is raised and adding the profiles is canceled, as we are trying to
register performance profile corresponding to other point of history. Otherwise the
<a class="reference internal" href="profile.html#perfreg-origin"><code class="xref std std-preg docutils literal"><span class="pre">origin</span></code></a> is removed from the profile and will not be stored in persistent storage.</li>
<li>We construct the header for the profile consisting of <code class="docutils literal"><span class="pre">profile</span></code> prefix, the type of the
specified by <a class="reference internal" href="profile.html#perfkey-type"><em class="xref std std-pkey">type</em></a> and length of the unpacked <a class="reference external" href="https://www.json.org/">JSON</a> representation of profile, joined
by spaces and ended by null byte.</li>
<li><a class="reference external" href="https://www.json.org/">JSON</a> contents of performance profile are appended to the header resulting into one <code class="docutils literal"><span class="pre">object</span></code>.</li>
<li>An SHA-1 hash <code class="docutils literal"><span class="pre">checksum</span></code> is computed out of the <code class="docutils literal"><span class="pre">object</span></code>. The hash serves both as a check
that the profile was not damaged during next usage, as well as identification in the
filesystem.</li>
<li>The <code class="docutils literal"><span class="pre">object</span></code> is compressed using <cite>zlib</cite> compression method and stored in the
<code class="docutils literal"><span class="pre">.perun/objects</span></code> directory. First two characters of <code class="docutils literal"><span class="pre">checksum</span></code> specifies the target
directory and the rest specifies the resulting filename.</li>
<li>An index corresponding to the <code class="docutils literal"><span class="pre">HEAD</span></code> minor version is opened (if it does not exist, it is
newly created first). Minor version index is also represented by its hash, where first two
characters of hash is used as directory and the rest as filename.</li>
<li>An entry for <code class="docutils literal"><span class="pre">sll-vs-skiplist.perf</span></code> with given modification time is registered within the
index pointing to the <code class="docutils literal"><span class="pre">checksum</span></code> object with compressed data. The number of registered
profiles in index is increased.</li>
<li>Unless it is specified otherwise, the <code class="docutils literal"><span class="pre">sll-vs-skiplist.perf</span></code> is removed from filesystem.</li>
</ol>
</div></blockquote>
<a class="reference internal image-reference" href="_images/register-profile.svg"><div align="center" class="align-center"><img alt="_images/register-profile.svg" src="_images/register-profile.svg" width="100%" /></div>
</a>
</div>
<div class="section" id="removing-profile-from-index">
<h4>Removing profile from index<a class="headerlink" href="#removing-profile-from-index" title="Permalink to this headline">¶</a></h4>
<p>Given a profile filename <code class="docutils literal"><span class="pre">sll-vs-skiplist.perf</span></code>, removing it from the <code class="docutils literal"><span class="pre">HEAD</span></code> minor version
index, requires the following steps to be executed:</p>
<blockquote>
<div><ol class="arabic simple">
<li>An index corresponding to the <code class="docutils literal"><span class="pre">HEAD</span></code> minor version is opened. Minor version index is
represented by its hash, where first two characters of hash is used as directory and the
rest as filename. If the index does not exist, removing ends with an error.</li>
<li>An entry for <code class="docutils literal"><span class="pre">sll-vs-skiplist.perf</span></code> is looked up within within the index. If it is not
found, the removing ends with an error. Other wise, the entry is removed from the index and
the number of registered profiles in index is decreased.</li>
<li>The original compresed object, which was stored in the entry is kept in the
<code class="docutils literal"><span class="pre">.perun/objects</span></code> directory.</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="looking-up-profile">
<h4>Looking up profile<a class="headerlink" href="#looking-up-profile" title="Permalink to this headline">¶</a></h4>
<p>Profiles are looked-up during the <code class="docutils literal"><span class="pre">perun</span> <span class="pre">show</span></code>, <code class="docutils literal"><span class="pre">perun</span> <span class="pre">add</span></code>, <code class="docutils literal"><span class="pre">perun</span> <span class="pre">postprocessby</span></code> or <code class="docutils literal"><span class="pre">perun</span>
<span class="pre">rm</span></code> and can be found in several places, namely the filesystem, pending storage or registered in
index. Priorities during the lookup are usually as follows:</p>
<blockquote>
<div><ol class="arabic simple">
<li>If the specification of profile is in form of <code class="docutils literal"><span class="pre">i&#64;i</span></code> or <code class="docutils literal"><span class="pre">i&#64;p</span></code> (i.e. the <cite>index</cite> and
<cite>pending</cite> tags respectively), then <code class="docutils literal"><span class="pre">i</span></code> th profile registered in index or stored in
pending jobs directory (<code class="docutils literal"><span class="pre">.perun/jobs</span></code>) is used.</li>
<li>Index of corresponding minor version is searched.</li>
<li>Absolute path in filesystem is checked.</li>
<li><code class="docutils literal"><span class="pre">.perun/jobs</span></code> directory is searched for match, i.e. one can specify just partial name of
the profile during the lookup.</li>
<li>Otherwise the whole scope of filesystem is walked. Each successful match asks user for
confirmation until the profile is found.</li>
</ol>
</div></blockquote>
<p>Refer to <a class="reference internal" href="cli.html"><span class="doc">Command Line Interface</span></a> for precise specification of lookups during individual commands.</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo">
  <a href="index.html">
    <h3>Perun</h3>
  </a>
</p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Perun Internals</a><ul>
<li><a class="reference internal" href="#version-control-systems">Version Control Systems</a><ul>
<li><a class="reference internal" href="#module-perun.vcs">Version Control System API</a></li>
<li><a class="reference internal" href="#creating-support-for-custom-vcs">Creating Support for Custom VCS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#perun-storage">Perun Storage</a><ul>
<li><a class="reference internal" href="#perun-index-specification">Perun Index Specification</a></li>
<li><a class="reference internal" href="#perun-object-specification">Perun Object Specification</a></li>
<li><a class="reference internal" href="#the-lifetime-of-profile-internals">The Lifetime of profile: Internals</a><ul>
<li><a class="reference internal" href="#registering-new-profile">Registering new profile</a></li>
<li><a class="reference internal" href="#removing-profile-from-index">Removing profile from index</a></li>
<li><a class="reference internal" href="#looking-up-profile">Looking up profile</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="logs.html" title="previous chapter">Customize Logs and Statuses</a></li>
      <li>Next: <a href="changelog.html" title="next chapter">Changelog</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/internals.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Tomas Fiedor, Jiri Pavela, et al..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="_sources/internals.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>